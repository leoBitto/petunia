# ðŸ“˜ Operational Guide & Architecture

This guide details the lifecycle of the **Money** trading system, how security is managed, and the workflow for local development versus production deployment.

---

## ðŸ—ï¸ Secret Management & Architecture

The core principle is **Zero Trust Codebase**: No secrets (passwords, API keys) must ever be committed to the Git repository.

### 1. The Two Sources of Truth
The application requires two types of configuration to run:
1.  **Environment Variables (`.env`)**: Database credentials, Google Sheet IDs, App settings.
2.  **File-based Credentials (`service_account.json`)**: The RSA key for Google Cloud API access.

### 2. Local Development Flow
In a local environment, you are the secret manager.
* Manually create a `.env` file in the project root (use `.env.example` as a template).
* Download the Service Account JSON key from GCP and place it in `config/credentials/service_account.json`.
* Docker will mount these files into the container at runtime.

### 3. Production Flow (CI/CD Automation)
In production, we do not copy files manually. GitHub Actions handles this.
1.  Secrets are stored in **GitHub Repository Secrets** (encrypted).
2.  During deployment:
    * The CI pipeline connects via SSH to the VM.
    * It **dynamically generates** the `.env` file from stored secrets.
    * It **dynamically generates** the `service_account.json` file.
    * Docker is launched using these fresh files.

---

## ðŸ’» Local Development Guide

You can test the entire system on your local machine before deploying to the cloud.

### Prerequisites
* Docker & Docker Compose installed.
* `.env` file configured.
* `config/credentials/service_account.json` file present.

### Operational Commands (via `manager.sh`)

| Action | Command | Description |
| :--- | :--- | :--- |
| **Setup** | `./manager.sh setup` | Creates data directories and builds the Docker image. |
| **Start DB** | `./manager.sh start` | Starts the PostgreSQL container in background. |
| **Status** | `./manager.sh status` | Checks running containers. |
| **Daily Run** | `./manager.sh daily` | Fetches OHLC data, updates portfolio, executes shadow orders. |
| **Weekly Run** | `./manager.sh weekly` | Runs strategy engine, risk management, and updates Orders Sheet. |
| **Backtest** | `./manager.sh backtest` | Simulates strategy on historical data. |
| **Stop** | `./manager.sh stop` | Stops all containers (Data is persisted). |

---

## ðŸš¢ Docker Architecture

The system consists of two containers operating within the `money_net` bridge network.

### 1. `db` (PostgreSQL)
* **Role:** Data persistence (OHLC, Portfolio, Trades).
* **Port:** 5432 (Exposed locally).
* **Persistence:** Data stored in host volume `./data/db`.
* **Lifecycle:** Always on (`restart: unless-stopped`).

### 2. `app` (Python Worker)
* **Role:** Business logic execution (Daily, Weekly, Backtest).
* **Data Access:**
    * Connects to DB via host `db`.
    * Reads credentials mounted from `./config/credentials`.
    * Reads/Writes reports to `./data`.
* **Lifecycle:** Ephemeral. Starts -> Executes Script -> Dies. Consumes zero RAM when idle.

---

## ðŸ”’ Security Checklist

* [ ] `.env` is included in `.gitignore`.
* [ ] `config/credentials/` is included in `.gitignore`.
* [ ] `data/` is included in `.gitignore`.
* [ ] Docker Compose uses `${UID}:${GID}` to prevent root-owned file creation on host.